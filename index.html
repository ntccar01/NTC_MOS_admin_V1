<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾Œå°ç®¡ç† - åœ‹ç«‹è‡ºæ±å°ˆç§‘å­¸æ ¡å“¡ç”Ÿç¤¾</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f1f5f9; margin: 0; padding: 20px; }
        .admin-container { max-width: 1100px; /* ç¨å¾®åŠ å¯¬ä»¥å®¹ç´é›»è©±æ¬„ä½ */ margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #1e3a8a; border-bottom: 2px solid #1e3a8a; padding-bottom: 10px; }
        
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9em; display: flex; align-items: center; gap: 5px; }
        .btn-refresh { background: #1e3a8a; color: white; }
        .btn-download { background: #0891b2; color: white; }
        .btn-google { background: #16a34a; color: white; }
        .btn-print { background: #475569; color: white; }
        .btn-clear { background: #b91c1c; color: white; } 
        .btn-gas { background: #9333ea; color: white; }    
        .btn-del { background: #ef4444; color: white; padding: 5px 12px; font-size: 0.85em; }

        .summary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin-bottom: 30px; }
        .summary-card { background: #eff6ff; padding: 12px; border-radius: 8px; border: 1px solid #bfdbfe; text-align: center; }
        .summary-card h3 { margin: 0; font-size: 0.85em; color: #1e40af; }
        .summary-card p { margin: 5px 0 0; font-size: 1.3em; font-weight: bold; color: #ef4444; }
        
        .card-revenue { background: #ecfdf5; border: 1px solid #10b981; }
        .card-revenue h3 { color: #065f46; }
        .card-revenue p { color: #059669; }

        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th, td { border: 1px solid #cbd5e1; padding: 8px 10px; text-align: left; }
        th { background: #f8fafc; }

        .pay-checkbox-wrapper { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .pay-checkbox { width: 16px; height: 16px; cursor: pointer; }
        .text-paid { color: #059669; font-weight: bold; }

        @media print {
            @page { size: A4 landscape; margin: 1cm; } /* æ”¹ç‚ºæ©«å‘åˆ—å°ä»¥å…æ¬„ä½å¤ªæ“  */
            body { background: white; padding: 0; }
            .admin-container { box-shadow: none; width: 100%; max-width: 100%; margin: 0; padding: 0; }
            .toolbar, .btn-del, .pay-checkbox, .btn-gas { display: none !important; }
            h1 { font-size: 1.5em; text-align: center; }
            table { font-size: 10pt; }
            th { background: #eee !important; color: black; }
            .summary-grid { grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>
<body>

<div class="admin-container">
    <h1>ğŸ“‹ å“¡ç”Ÿç¤¾è¨‚å–®ç®¡ç†å¾Œå°</h1>
    
    <div class="toolbar">
        <button class="btn btn-refresh" onclick="loadTodayOrders()">ğŸ”„ é‡æ–°æ•´ç†</button>
        <button class="btn btn-download" onclick="exportTxt()">ğŸ“ ä¸‹è¼‰ TXT</button>
        <button class="btn btn-download" onclick="exportCsv()">ğŸ“Š ä¸‹è¼‰ CSV</button>
        <button class="btn btn-google" onclick="uploadToGoogleSheet()">ğŸ“¤ åŒæ­¥è©¦ç®—è¡¨</button>
        <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å° A4 å ±è¡¨</button>
        <button class="btn btn-clear" onclick="clearTodayOrders()">ğŸ—‘ï¸ æ¸…é™¤ä»Šæ—¥è³‡æ–™</button>
        <button class="btn btn-gas" onclick="openGasTutorial()">â“ GAS æ•™å­¸</button>
    </div>

    <div id="summary-section">
        <h2>ğŸ“Š ä»Šæ—¥æ•¸æ“šçµ±è¨ˆ</h2>
        <div id="summary-content" class="summary-grid">è¼‰å…¥ä¸­...</div>
    </div>

    <h2>ğŸ“ è¨‚å–®æ˜ç´°</h2>
    <table>
        <thead>
            <tr>
                <th width="8%">æ™‚é–“</th>
                <th width="12%">ç­ç´š/è™•å®¤</th>
                <th width="10%">è² è²¬äºº</th>
                <th width="12%">è¯çµ¡é›»è©±</th> <th width="30%">æ˜ç´° (åº§è™Ÿ/å§“å)</th>
                <th width="8%">é‡‘é¡</th>
                <th width="10%">ç‹€æ…‹</th>
                <th width="8%" class="btn-del">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="order-list"></tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc, deleteDoc, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDhI4QdbwUCx7ch-Js4XFIpQmaH03do7bo",
        authDomain: "ntc-lunch-system-2025v1.firebaseapp.com",
        projectId: "ntc-lunch-system-2025v1",
        storageBucket: "ntc-lunch-system-2025v1.firebasestorage.app",
        messagingSenderId: "235133418606",
        appId: "1:235133418606:web:42ed342fa44dcf17c67a7f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentOrders = [];

    // æ ¼å¼åŒ–æ—¥æœŸç‚º YYYYMMDD
    function getFormattedDate() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        return `${y}${m}${d}`;
    }

    window.loadTodayOrders = async function() {
        const listBody = document.getElementById('order-list');
        const summaryDiv = document.getElementById('summary-content');
        const startOfDay = new Date(); startOfDay.setHours(0,0,0,0);
        try {
            const q = query(collection(db, "orders"), where("order_time", ">=", startOfDay), orderBy("order_time", "desc"));
            const querySnapshot = await getDocs(q);
            currentOrders = [];
            let summaryData = {};
            let paidTotal = 0;
            let unpaidTotal = 0;
            let listHtml = "";

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const id = doc.id;
                currentOrders.push({ id, ...data });
                let itemsText = data.order_items.map(i => {
                    summaryData[i.name] = (summaryData[i.name] || 0) + i.qty;
                    return `${i.name}x${i.qty} <small>(${i.note})</small>`;
                }).join('<br>');
                const isPaid = data.paid || false;
                if (isPaid) { paidTotal += data.total_amount; } else { unpaidTotal += data.total_amount; }
                
                // è™•ç†é›»è©±é¡¯ç¤ºï¼Œè‹¥ç„¡å‰‡é¡¯ç¤ºç©ºç™½
                const displayPhone = data.phone || '<span style="color:#ccc;font-size:0.8em;">(æœªå¡«)</span>';

                listHtml += `<tr>
                    <td>${data.order_time?.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
                    <td><b>${data.class}</b></td>
                    <td>${data.name}</td>
                    <td>${displayPhone}</td> <td>${itemsText}</td>
                    <td>$${data.total_amount}</td>
                    <td>
                        <label class="pay-checkbox-wrapper">
                            <input type="checkbox" class="pay-checkbox" ${isPaid ? 'checked' : ''} onchange="togglePaidStatus('${id}', this.checked)">
                            <span class="${isPaid ? 'text-paid' : ''}">${isPaid ? 'å·²ä»˜è²»' : 'æœªä»˜'}</span>
                        </label>
                    </td>
                    <td class="btn-del">
                        <button class="btn-del" onclick="deleteOrder('${id}')">åˆª</button>
                    </td>
                </tr>`;
            });
            let summaryHtml = Object.entries(summaryData).map(([n, q]) => `<div class="summary-card"><h3>${n}</h3><p>${q} ä»½</p></div>`).join('');
            summaryHtml += `
                <div class="summary-card card-revenue"><h3>ğŸ’° å·²æ”¶ç¸½é¡</h3><p>$${paidTotal}</p></div>
                <div class="summary-card" style="background:#fff7ed; border-color:#fdba74;"><h3>â³ æœªæ”¶ç¸½é¡</h3><p>$${unpaidTotal}</p></div>`;
            listBody.innerHTML = listHtml || "<tr><td colspan='8'>ä»Šæ—¥å°šç„¡è¨‚å–®</td></tr>";
            summaryDiv.innerHTML = summaryHtml || "ç„¡çµ±è¨ˆæ•¸æ“š";
        } catch (e) { console.error(e); }
    };

    window.togglePaidStatus = async (id, isChecked) => {
        try { await updateDoc(doc(db, "orders", id), { paid: isChecked }); loadTodayOrders(); } catch (e) { alert("æ›´æ–°å¤±æ•—"); }
    };

    window.deleteOrder = async (id) => {
        if (confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ")) { await deleteDoc(doc(db, "orders", id)); loadTodayOrders(); }
    };

    window.clearTodayOrders = async () => {
        if (confirm("ğŸš¨ è­¦å‘Šï¼šé€™å°‡åˆªé™¤ä»Šæ—¥æ‰€æœ‰è³‡æ–™ï¼")) {
            const batch = writeBatch(db);
            currentOrders.forEach(o => batch.delete(doc(db, "orders", o.id)));
            await batch.commit(); loadTodayOrders();
        }
    };

    // âœ… TXT åŒ¯å‡ºï¼šåŠ å…¥é›»è©±æ¬„ä½
    window.exportTxt = () => {
        const dateStr = getFormattedDate();
        let txt = `åœ‹ç«‹è‡ºæ±å°ˆç§‘å­¸æ ¡å“¡ç”Ÿç¤¾ è¨‚å–®å ±è¡¨ (${dateStr})\n` + "=".repeat(60) + "\n";
        currentOrders.forEach(o => {
            const items = o.order_items.map(i => `${i.name}x${i.qty}(è¨»è¨˜:${i.note})`).join(', ');
            const phoneStr = o.phone ? `(é›»è©±: ${o.phone})` : "";
            txt += `[${o.class}] ${o.name} ${phoneStr} | é‡‘é¡:$${o.total_amount} | ç‹€æ…‹:${o.paid?'å·²ä»˜':'æœªä»˜'}\næ˜ç´°ï¼š${items}\n` + "-".repeat(60) + "\n";
        });
        const blob = new Blob([txt], {type: "text/plain;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${dateStr}ä¾¿ç•¶è¨‚å–®åç´°.txt`;
        a.click();
    };

    // âœ… CSV åŒ¯å‡ºï¼šåŠ å…¥é›»è©±æ¬„ä½
    window.exportCsv = () => {
        const dateStr = getFormattedDate();
        // å¢åŠ  \t é˜²æ­¢ Excel å°‡é›»è©±è™Ÿç¢¼é–‹é ­çš„ 0 åƒæ‰
        let csv = "\uFEFFæ™‚é–“,ç­ç´š,å§“å,è¯çµ¡é›»è©±,å…§å®¹(å«è¨»è¨˜),ç¸½é‡‘é¡,ä»˜è²»ç‹€æ…‹\n";
        currentOrders.forEach(o => {
            let items = o.order_items.map(i => `${i.name}x${i.qty}(${i.note})`).join(' | ');
            const phoneStr = o.phone ? `="${o.phone}"` : ""; // å¼·åˆ¶ Excel é¡¯ç¤ºç‚ºæ–‡å­—ä»¥ä¿ç•™ 0
            csv += `${o.order_time?.toDate().toLocaleTimeString()},${o.class},${o.name},${phoneStr},"${items}",${o.total_amount},${o.paid?'å·²ä»˜è²»':'æœªä»˜è²»'}\n`;
        });
        const blob = new Blob([csv], {type: "text/csv;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${dateStr}ä¾¿ç•¶è¨‚å–®åç´°.csv`;
        a.click();
    };

    window.openGasTutorial = () => {
        const helpWin = window.open("", "_blank", "width=800,height=800");
        helpWin.document.write(`
            <div style="font-family: sans-serif; padding: 30px; line-height: 1.6; color: #333;">
                <h2 style="color:#1e3a8a; border-bottom: 2px solid #1e3a8a; padding-bottom: 10px;">ğŸš€ GAS æ•™å­¸</h2>
                <p>è«‹å°‡ä»¥ä¸‹ç¨‹å¼ç¢¼è²¼å…¥ Google Apps Script ä¸¦éƒ¨ç½²ï¼ˆå¦‚æœå·²éƒ¨ç½²éï¼Œè«‹æ›´æ–°ç¨‹å¼ç¢¼ä¸¦å„²å­˜ï¼‰ï¼š</p>
                <pre style="background:#f4f4f4; padding:15px; border-radius:8px; border:1px solid #ccc; font-family: monospace; font-size: 13px; overflow-x: auto;">
function doPost(e) {
  var orders = JSON.parse(e.postData.contents);
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  
  // æª¢æŸ¥æ¨™é¡Œåˆ—ï¼Œè‹¥ç„¡å‰‡æ–°å¢ (åŒ…å«é›»è©±æ¬„ä½)
  if (sheet.getLastRow() === 0) {
    sheet.appendRow(["åŒæ­¥æ™‚é–“", "ç­ç´š/è™•å®¤", "è² è²¬äºº", "è¯çµ¡é›»è©±", "è¨‚è³¼æ˜ç´° (å«è¨»è¨˜)", "ç¸½é‡‘é¡", "ä»˜è²»ç‹€æ…‹"]);
  }
  
  orders.forEach(function(o) {
    var itemDesc = o.order_items.map(function(i){ return i.name + "x" + i.qty + "(" + i.note + ")"; }).join(", ");
    // "'" + o.phone æ˜¯ç‚ºäº†å¼·åˆ¶ Google Sheet è¦–ç‚ºæ–‡å­—ï¼Œä¿ç•™é–‹é ­çš„ 0
    sheet.appendRow([new Date(), o.class, o.name, "'" + (o.phone || ""), itemDesc, o.total_amount, o.paid ? "å·²ä»˜è²»" : "æœªä»˜"]);
  });
  
  return ContentService.createTextOutput("Success").setMimeType(ContentService.MimeType.TEXT);
}</pre>
                <p style="color:red; font-weight:bold;">âš ï¸ æ³¨æ„ï¼šè«‹ç¢ºä¿å‰å°é€å‡ºçš„è³‡æ–™ç¢ºå¯¦åŒ…å« phone æ¬„ä½ã€‚</p>
            </div>
        `);
    };

    window.uploadToGoogleSheet = async () => {
        const gasUrl = "https://script.google.com/macros/s/AKfycbz7VhiKko_WDRf6OZjMnooGq67zatD35lK_rM1zB47IGagLSeegJR4a_hLg0yPXG8AA/exec"; 
        if (!confirm("ç¢ºå®šè¦åŒæ­¥ä»Šæ—¥è¨‚å–®è‡³ Google è©¦ç®—è¡¨å—ï¼Ÿ")) return;
        try {
            await fetch(gasUrl, { 
                method: "POST", 
                mode: "no-cors", 
                headers: { "Content-Type": "application/json" }, 
                body: JSON.stringify(currentOrders) 
            });
            alert("åŒæ­¥æŒ‡ä»¤å·²ç™¼é€ï¼");
        } catch (e) { alert("åŒæ­¥å¤±æ•—"); }
    };

    loadTodayOrders();
</script>
</body>
</html>